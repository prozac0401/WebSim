<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>개미-질소 순환 시뮬레이터</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #ffffff;
    }
    #canvas {
      border: 1px solid #ddd;
      display: block;
      margin: 0 auto;
      background: #f8f9fa;
    }
    .controls {
      max-width: 600px;
      margin: 10px auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">개미-질소 순환 시뮬레이터</h1>
  <p style="text-align:center;">개미가 유기물을 운반해 토양의 질소를 증가시키고 식물을 성장시키는 과정을 관찰해보세요.</p>
  <div class="controls">
    <label>개미 수: <span id="antCountLabel">30</span></label>
    <input id="antCount" type="range" min="10" max="100" value="30" />
  </div>
  <div id="stats" style="text-align:center;margin-bottom:10px;">&nbsp;</div>
  <script>
    const GRID_SIZE = 20;
    const CELL_SIZE = 20;
    const WIDTH = GRID_SIZE * CELL_SIZE;
    const HEIGHT = 30 * CELL_SIZE;
    const NEST_X = Math.floor(GRID_SIZE/2);
    const NEST_Y = Math.floor(HEIGHT/CELL_SIZE/2);

    let soil = [];
    let ants = [];
    let foodSources = [];

    class SoilCell {
      constructor(x, y) {
        this.x = x; this.y = y;
        this.organic = 0;
        this.nitrogen = 0;
        this.plant = 0;
        this.pheromone = 0;
      }
      update() {
        let dn = this.organic * 0.02;
        this.nitrogen += dn;
        this.organic -= dn;
        let uptake = this.nitrogen * 0.01;
        this.plant += uptake*5;
        this.nitrogen -= uptake;
        this.plant = constrain(this.plant, 0, CELL_SIZE-2);
        this.pheromone *= 0.95;
      }
      display() {
        let n = constrain(this.nitrogen*40, 0, 200);
        fill(200-n, 255-n, 200-n);
        rect(this.x*CELL_SIZE, this.y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
        if(this.pheromone>0.1){
          const alpha = constrain(this.pheromone*50,0,150);
          fill(180,80,200,alpha);
          rect(this.x*CELL_SIZE, this.y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
        }
        if(this.plant > 1){
          fill(50,150,50);
          rect(this.x*CELL_SIZE+CELL_SIZE/2-2, this.y*CELL_SIZE+CELL_SIZE-this.plant, 4, this.plant);
        }
      }
    }

    class FoodSource {
      constructor(x,y,amount){
        this.pos = createVector(x,y);
        this.amount = amount;
      }
      display(){
        if(this.amount>0){
          fill('orange');
          ellipse(this.pos.x, this.pos.y, 8,8);
        }
      }
    }

    class Ant {
      constructor(){
        this.pos = createVector(random(width), random(height));
        this.carrying = false;
      }
      update(){
        if(this.carrying){
          let target = createVector(NEST_X*CELL_SIZE+CELL_SIZE/2,NEST_Y*CELL_SIZE+CELL_SIZE/2);
          this.pos.add(p5.Vector.sub(target,this.pos).setMag(1));
          if(p5.Vector.dist(this.pos,target)<5){
            soil[NEST_X][NEST_Y].organic += 5;
            this.carrying=false;
          }
          soil[Math.floor(this.pos.x/CELL_SIZE)][Math.floor(this.pos.y/CELL_SIZE)].pheromone += 0.5;
        }else{
          let nearest = null;
          let dmin = 9999;
          for(let fs of foodSources){
            if(fs.amount>0){
              let d = p5.Vector.dist(this.pos,fs.pos);
              if(d<dmin){dmin=d; nearest=fs;}
            }
          }
          if(nearest && dmin<5){
            nearest.amount -= 5;
            this.carrying=true;
          }else if(nearest && dmin<80){
            this.pos.add(p5.Vector.sub(nearest.pos,this.pos).setMag(1));
          }else{
            this.pos.add(p5.Vector.random2D());
          }
          soil[Math.floor(this.pos.x/CELL_SIZE)][Math.floor(this.pos.y/CELL_SIZE)].pheromone += 0.2;
        }
        this.pos.x = constrain(this.pos.x,0,width-1);
        this.pos.y = constrain(this.pos.y,0,height-1);
      }
      display(){
        fill(this.carrying?'#e67e22':'#000');
        ellipse(this.pos.x,this.pos.y,5,5);
      }
    }

    function setup(){
      let canvas = createCanvas(WIDTH, HEIGHT);
      canvas.id('canvas');
      for(let x=0;x<GRID_SIZE;x++){
        soil[x]=[];
        for(let y=0;y<HEIGHT/CELL_SIZE;y++){
          soil[x][y]=new SoilCell(x,y);
        }
      }
      initFood();
      initAnts(30);
      document.getElementById('antCount').addEventListener('input', e=>{
        const val = parseInt(e.target.value);
        document.getElementById('antCountLabel').textContent = val;
        initAnts(val);
      });
    }

    function draw(){
      background(250);
      for(let x=0;x<GRID_SIZE;x++){
        for(let y=0;y<HEIGHT/CELL_SIZE;y++){
          soil[x][y].update();
          soil[x][y].display();
        }
      }
      for(let fs of foodSources){fs.display();}
      for(let ant of ants){ant.update(); ant.display();}
      // nest
      fill('#b5651d');
      rect(NEST_X*CELL_SIZE,NEST_Y*CELL_SIZE,CELL_SIZE,CELL_SIZE);

      if(mouseX>=0 && mouseX<width && mouseY>=0 && mouseY<height){
        const cx = Math.floor(mouseX/CELL_SIZE);
        const cy = Math.floor(mouseY/CELL_SIZE);
        const cell = soil[cx][cy];
        document.getElementById('stats').textContent =
          `위치 (${cx},${cy}) - 페로몬: ${cell.pheromone.toFixed(1)} `+
          `질소: ${cell.nitrogen.toFixed(1)} 식물: ${cell.plant.toFixed(1)}`;
      }
    }

    function initFood(){
      foodSources=[];
      for(let i=0;i<3;i++){
        foodSources.push(new FoodSource(random(width), random(height), 100));
      }
    }

    function initAnts(n){
      ants=[];
      for(let i=0;i<n;i++) ants.push(new Ant());
    }
  </script>
</body>
</html>
