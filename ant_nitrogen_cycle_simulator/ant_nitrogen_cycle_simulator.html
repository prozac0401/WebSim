<!-- Ant–Nitrogen Cycle Simulator (v3 – complete, render‑ready)
     ▣ 주요 특징 ▣
     ● 현실적 꽃 개화 로직 (질소·유기물·성숙·확률)
     ● 잠재 개화 지역 실시간 음영(분홍) + 질소(녹), 유기물(갈색) 음영
     ● Controls: 개미 수, 양분 패치 크기·주기, 스타트/스톱/리셋
     ● p5.js 단일 스케치 – 모든 변수 / 함수 전역 노출 없어 충돌 방지
-->
<div id="ant-n-cycle">
  <style>
    #ant-n-cycle{margin:0 auto;padding:10px;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;max-width:930px;text-align:center;box-sizing:border-box;}
    #ant-n-cycle canvas{display:block;margin:0 auto;background:#f8f9fa;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.2);width:100%;max-width:930px;}
    #ant-n-cycle .controls{width:100%;margin:10px auto;text-align:center;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>

  <!-- ─────── UI ─────── -->
  <div class="controls">
    <label>개미 수: <span id="antCountLabel">100</span></label>
    <input id="antCount" type="range" min="10" max="500" value="100" />
    <br/>
    <label>양분 패치 크기: <span id="nutrientAmountLabel">50</span></label>
    <input id="nutrientAmount" type="range" min="10" max="500" value="50" />
    <br/>
    <label>양분 생성주기(초): <span id="nutrientIntervalLabel">5</span></label>
    <input id="nutrientInterval" type="range" min="1" max="20" value="5" />
  </div>

  <!-- Legend -->
  <div id="legend" style="max-width:830px;margin:0 auto 10px auto;font-size:14px;width:100%;">
    <style>#legend svg{width:12px;height:12px;margin-left:10px;vertical-align:middle;}#legend svg:first-child{margin-left:0;}</style>
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#b5651d"/></svg>둥지
    <svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="2" fill="#000"/><circle cx="6" cy="6" r="2.5" fill="#000"/><circle cx="6" cy="9" r="3" fill="#000"/></svg>개미
    <svg viewBox="0 0 12 12"><circle cx="6" cy="6" r="4" fill="#ffb6c1"/></svg>사탕 부스러기(양분)
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#228B22" opacity="0.6"/></svg>질소 농도
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#8B4513" opacity="0.6"/></svg>유기물 농도
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#FF69B4" opacity="0.6"/></svg>개화 가능 지역
  </div>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="resetBtn">Reset</button>
  </div>

  <script>
  (function(){
    /* ─────────────── CONSTS & GLOBALS ─────────────── */
    const GRID = 30;
    const TREE_LIFESPAN = 800;
    const MAX_NESTS = 6;

    /* 개화 조건 */
    const N_THRESHOLD   = 3;
    const O_THRESHOLD   = 2;
    const AGE_THRESHOLD = 120;
    const BLOOM_CHANCE  = 0.3;

    /* dynamic sizing */
    let CELL, W, H;
    let ANT_SIZE, ANT_SPEED;

    /* environment */
    let soil=[];        // 2‑D SoilCell
    let ants=[];        // Ant[]
    let food=[];        // FoodSource[]
    let nestCount, NEST_X, NEST_Y;

    /* nutrient event control */
    let nutrientAmt = 50;
    let nutrientInterval = 5*60; // frames
    let nextNutrientFrame;

    /* p5 instance mode (isolated) */
    new p5(p=>{
      p.setup = function(){
        /* canvas & cell size */
        const side = Math.min(window.innerWidth,930);
        CELL = Math.floor(side/GRID);
        W = H = CELL*GRID;
        ANT_SIZE = CELL*0.4;
        ANT_SPEED = CELL*0.1;
        p.createCanvas(W,H).id('canvas');

        /* init soil grid */
        for(let x=0;x<GRID;x++){
          soil[x]=[];
          for(let y=0;y<GRID;y++){ soil[x][y] = new SoilCell(x,y); }
        }
        NEST_X = Math.floor(GRID/2); NEST_Y = Math.floor(GRID/2);
        soil[NEST_X][NEST_Y].isNest = true; nestCount = 1;

        initFood();
        initAnts(100);
        nextNutrientFrame = nutrientInterval;
        attachUI();
      };

      p.draw = function(){
        p.background(250);
        if(p.frameCount>=nextNutrientFrame){ spawnNutrientPatch(); nextNutrientFrame=p.frameCount+nutrientInterval; }

        /* update soil */
        for(let x=0;x<GRID;x++) for(let y=0;y<GRID;y++){ soil[x][y].update(); soil[x][y].displayGround(); }

        /* food render & clean */
        food.forEach(f=>f.display());
        food = food.filter(f=>f.amount>0);

        /* ants update */
        ants.forEach(a=>{a.update(); a.display();});
        ants = ants.filter(a=>!a.dead);

        /* plants render after ground so they're on top */
        for(let x=0;x<GRID;x++) for(let y=0;y<GRID;y++){ soil[x][y].displayPlant(); }
      };

      /* ─────────────── CLASSES ─────────────── */
      class SoilCell{
        constructor(x,y){Object.assign(this,{x,y,organic:0,nitrogen:0,plant:0,plantAge:0,isNest:false,pheromone:0,treeSpawned:false,bloomCounter:0,bloomPotential:0});}
        update(){
          /* nutrient cycling */
          this.nitrogen += this.organic*0.02;  this.organic*=0.98;
          const uptake = this.nitrogen*0.01;   this.plant += uptake*5;  this.nitrogen -= uptake;
          const decay  = this.plant*0.005;     this.plant -= decay;      this.nitrogen += decay;

          /* bloom potential calc for non‑nest bare soil */
          if(!this.isNest && this.plant<=1){
            this.bloomPotential = p.constrain(((this.nitrogen/N_THRESHOLD)+(this.organic/O_THRESHOLD))/2,0,1);
            if(this.bloomPotential>=1){ this.bloomCounter++; }
            else{ this.bloomCounter=0; }
            if(this.bloomCounter>AGE_THRESHOLD && p.random()<BLOOM_CHANCE && !this.treeSpawned){ this.plant = 2; this.treeSpawned=true; }
          } else { this.bloomPotential=0; this.bloomCounter=0; }

          /* aging tree */
          if(this.plant>1){ this.plantAge++; if(this.plantAge>TREE_LIFESPAN){ this.nitrogen+=this.plant; this.plant=0; this.plantAge=0; this.treeSpawned=false; }}
        }
        displayGround(){
          p.noStroke(); p.fill('#FFFFF0'); p.rect(this.x*CELL,this.y*CELL,CELL,CELL);
          if(this.nitrogen>0.05){ p.fill(34,139,34,p.constrain(this.nitrogen*60,0,160)); p.rect(this.x*CELL,this.y*CELL,CELL,CELL);} // N
          if(this.organic>0.05){ p.fill(139,69,19,p.constrain(this.organic*60,0,160)); p.rect(this.x*CELL,this.y*CELL,CELL,CELL);}   // Organic
          if(this.bloomPotential>0 && this.plant<=1){ p.fill(255,105,180,p.constrain(this.bloomPotential*120,0,120)); p.rect(this.x*CELL,this.y*CELL,CELL,CELL);} // bloom potential
          if(this.isNest){ p.fill('#b5651d'); p.rect(this.x*CELL,this.y*CELL,CELL,CELL);} // nest
          if(this.pheromone>0.1){ p.fill(180,80,200,p.constrain(this.pheromone*50,0,150)); p.rect(this.x*CELL,this.y*CELL,CELL,CELL);} // pheromone overlay
        }
        displayPlant(){ if(this.plant>1){ drawCherryTree(this.x,this.y,this.plant); } }
      }

      /* ant */
      class Ant{
        constructor(){ this.pos=p.createVector(p.random(W),p.random(H)); this.prev=this.pos.copy(); this.vel=p.createVector(1,0); this.carrying=false; this.carryAmt=0; this.dead=false;}
        update(){
          const cx=p.floor(this.pos.x/CELL); const cy=p.floor(this.pos.y/CELL); const cell=soil[cx][cy];
          /* carry logic */
          if(this.carrying){ const nest=getNearestNest(this.pos); const tgt=p.createVector(nest.x*CELL+CELL/2,nest.y*CELL+CELL/2); this.pos.add(p5.Vector.sub(tgt,this.pos).setMag(ANT_SPEED)); if(p.dist(this.pos.x,this.pos.y,tgt.x,tgt.y)<3){ nest.organic+=this.carryAmt; this.carrying=false; }}
          else {
            /* find nearby food */
            let nearest=null, dmin=1e9;
            food.forEach(f=>{ if(f.amount>0){ const d=p.dist(this.pos.x,this.pos.y,f.pos.x,f.pos.y); if(d<dmin){dmin=d; nearest=f;} }});
            if(nearest && dmin<3){ const take=Math.min(5,nearest.amount); nearest.amount-=take; this.carrying=true; this.carryAmt=take; }
            else if(nearest && dmin<80){ this.pos.add(p5.Vector.sub(nearest.pos,this.pos).setMag(ANT_SPEED)); }
            else { this.randomWalk(); }
          }
          /* bounds */
          this.pos.x=p.constrain(this.pos.x,0,W-1); this.pos.y=p.constrain(this.pos.y,0,H-1);
          /* pheromone */
          soil[p.floor(this.pos.x/CELL)][p.floor(this.pos.y/CELL)].pheromone+=(this.carrying?0.6:0.2);
        }
        randomWalk(){ const dirs=[[0,-1],[1,0],[0,1],[-1,0]]; const d=p.random(dirs); this.pos.add(p.createVector(d[0]*ANT_SPEED,d[1]*ANT_SPEED)); }
        display(){ p.noStroke(); p.fill(this.carrying?'#d020d0':'#000'); p.ellipse(this.pos.x,this.pos.y,ANT_SIZE*0.6,ANT_SIZE*0.4); }
      }

      /* food */
      class FoodSource{
        constructor(x,y,amt){ this.pos=p.createVector(x,y); this.amount=this.init=amt; }
        display(){ if(this.amount<=0) return; const frac=this.amount/this.init; p.fill(255,182,193,200*frac+55); p.noStroke(); p.ellipse(this.pos.x,this.pos.y,CELL*frac*0.8+CELL*0.2); }
      }

      /* ─────────────── helper functions ─────────────── */
      function initAnts(n){ ants=[]; for(let i=0;i<n;i++) ants.push(new Ant()); }
      function initFood(){ food=[]; for(let i=0;i<3;i++){ food.push(new FoodSource(p.random(W),p.random(H),nutrientAmt)); } }
      function spawnNutrientPatch(){ const x=p.floor(p.random(GRID)); const y=p.floor(p.random(GRID)); food.push(new FoodSource(x*CELL+CELL/2,y*CELL+CELL/2,nutrientAmt)); }
      function getNearestNest(pos){ return soil[NEST_X][NEST_Y]; }

      /* cherry tree drawing */
      function drawCherryTree(x,y,h){ p.push(); p.translate(x*CELL+CELL/2,y*CELL+CELL); p.stroke(139,69,19); p.strokeWeight(6); p.line(0,0,0,-h); p.noStroke(); const rng=p.random; for(let i=0;i<20;i++){ const ang=rng()*p.TWO_PI; const rad=rng()*(h*0.6)+h*0.2; const sx=p.cos(ang)*rad; const sy=-h + p.sin(ang)*rad*0.5; const sz=rng()*(h*0.15)+h*0.15; p.fill(255,198,220,220); p.ellipse(sx,sy,sz);} p.pop(); }

      function attachUI(){
        document.getElementById('antCount').oninput=e=>{ const v=parseInt(e.target.value); document.getElementById('antCountLabel').textContent=v; initAnts(v); };
        document.getElementById('nutrientAmount').oninput=e=>{ nutrientAmt=parseInt(e.target.value); document.getElementById('nutrientAmountLabel').textContent=nutrientAmt; };
        document.getElementById('nutrientInterval').oninput=e=>{ const v=parseInt(e.target.value); nutrientInterval=v*60; document.getElementById('nutrientIntervalLabel').textContent=v; };
        document.getElementById('startBtn').onclick=()=>p.loop();
        document.getElementById('stopBtn').onclick=()=>p.noLoop();
        document.getElementById('resetBtn').onclick=()=>{ initFood(); initAnts(parseInt(document.getElementById('antCount').value)); soil.flat().forEach(c=>Object.assign(c,{organic:0,nitrogen:0,plant:0,plantAge:0,treeSpawned:false,pheromone:0,bloomCounter:0,bloomPotential:0,isNest:false})); soil[NEST_X][NEST_Y].isNest=true; nestCount=1; };
      }
    });
  })();
  </script>
</div>
