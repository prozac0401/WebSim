<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>개미-질소 순환 시뮬레이터</title>
  <!-- Load p5.js locally to avoid CDN issues -->
  <script src="p5.min.js"></script>
  <style>
    body {
    margin: 0;
    padding: 10px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #ffffff;
    }
    #canvas {
    border: 1px solid #ddd;
    display: block;
    margin: 0 auto;
    background: #f8f9fa;
    max-width: 800px;
    width: 100%;
    }
    .controls {
    max-width: 800px;
    width: 100%;
    margin: 10px auto;
    text-align: center;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">개미-질소 순환 시뮬레이터</h1>
  <p style="text-align:center;">개미가 유기물을 운반해 토양의 질소를 증가시키고 식물을 성장시키는 과정을 관찰해보세요.</p>
  <div class="controls">
    <label>개미 수: <span id="antCountLabel">30</span></label>
    <input id="antCount" type="range" min="10" max="100" value="30" />
    <br/>
    <label>질소량: <span id="nitrogenAmountLabel">50</span></label>
    <input id="nitrogenAmount" type="range" min="10" max="200" value="50" />
    <br/>
    <label>질소 생성주기(초): <span id="nitrogenIntervalLabel">5</span></label>
    <input id="nitrogenInterval" type="range" min="1" max="20" value="5" />
  </div>
  <div id="stats" style="text-align:center;margin-bottom:10px;">&nbsp;</div>
  <div id="legend" style="max-width:800px;margin:0 auto 10px auto;font-size:14px;width:100%;">
    <span style="display:inline-block;width:12px;height:12px;background:#b5651d;vertical-align:middle;margin-right:4px;"></span>둥지
    <span style="display:inline-block;width:12px;height:12px;background:black;margin:0 0 0 10px;vertical-align:middle;margin-right:4px;"></span>개미
    <span style="display:inline-block;width:12px;height:12px;background:yellow;margin:0 0 0 10px;vertical-align:middle;margin-right:4px;border-radius:50%;"></span>질소 패치
    <span style="display:inline-block;width:12px;height:12px;background:rgb(50,150,50);margin:0 0 0 10px;vertical-align:middle;margin-right:4px;"></span>식물
  </div>
  <script>
    const GRID_SIZE = 20;
    const GRID_HEIGHT = 30;
    let CELL_SIZE;
    let WIDTH;
    let HEIGHT;
    let NEST_X;
    let NEST_Y;
    let nitrogenAmount = 50;
    let nitrogenInterval = 5 * 60; // frames
    let nextNitrogenFrame = nitrogenInterval;

    let soil = [];
    let ants = [];
    let foodSources = [];
    let PLANT_THRESHOLD;

    class SoilCell {
    constructor(x, y) {
      this.x = x; this.y = y;
      this.organic = 0;
      this.nitrogen = 0;
      this.plant = 0;
      this.pheromone = 0;
      this.isNest = false;
    }
    update() {
      let dn = this.organic * 0.02;
      this.nitrogen += dn;
      this.organic -= dn;
      let uptake = this.nitrogen * 0.01;
      this.plant += uptake*5;
      this.nitrogen -= uptake;
      // decay old plants back to nitrogen
      let decay = this.plant * 0.005;
      this.plant -= decay;
      this.nitrogen += decay;
      this.plant = constrain(this.plant, 0, CELL_SIZE-2);
      this.pheromone *= 0.95;
      if(this.isNest && this.plant > PLANT_THRESHOLD){
        relocateNest(this);
      }
    }
    display() {
      let n = constrain(this.nitrogen*40, 0, 200);
      fill(220-n, 180+n/2, 120-n/3);
      rect(this.x*CELL_SIZE, this.y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
      if(this.pheromone>0.1){
        const alpha = constrain(this.pheromone*50,0,150);
        fill(180,80,200,alpha);
        rect(this.x*CELL_SIZE, this.y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
      }
      if(this.plant > 1){
        fill(50,150,50);
        rect(this.x*CELL_SIZE+CELL_SIZE/2-2, this.y*CELL_SIZE+CELL_SIZE-this.plant, 4, this.plant);
      }
      if(this.isNest){
        fill('#b5651d');
        rect(this.x*CELL_SIZE, this.y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
      }
    }
    }

    class FoodSource {
    constructor(x,y,amount){
      this.pos = createVector(x,y);
      this.amount = amount;
      this.initial = amount;
    }
    display(){
      if(this.amount>0){
        const r = CELL_SIZE*0.9;
        let ctx = drawingContext;
        let frac = this.amount/this.initial;
        let grad = ctx.createLinearGradient(this.pos.x, this.pos.y-r/2, this.pos.x, this.pos.y+r/2);
        let stop = Math.max(0,1-frac);
        grad.addColorStop(0,'rgba(255,255,0,0)');
        grad.addColorStop(stop,'rgba(255,255,0,0)');
        grad.addColorStop(stop,'rgba(255,255,0,1)');
        grad.addColorStop(1,'rgba(255,255,0,1)');
        ctx.fillStyle = grad;
        noStroke();
        ellipse(this.pos.x, this.pos.y, r, r*1.2);
      }
    }
    }

    class Ant {
    constructor(){
      this.pos = createVector(random(width), random(height));
      this.carrying = false;
    }
    update(){
      if(this.carrying){
        let nestCell = getNearestNest(this.pos);
        let target = createVector(nestCell.x*CELL_SIZE+CELL_SIZE/2,
                                 nestCell.y*CELL_SIZE+CELL_SIZE/2);
        this.pos.add(p5.Vector.sub(target,this.pos).setMag(1));
        if(p5.Vector.dist(this.pos,target)<5){
          nestCell.nitrogen += 5;
          this.carrying=false;
        }
      }else{
        let nearest = null;
        let dmin = 9999;
        for(let fs of foodSources){
          if(fs.amount>0){
            let d = p5.Vector.dist(this.pos,fs.pos);
            if(d<dmin){dmin=d; nearest=fs;}
          }
        }
        if(nearest && dmin<5){
          nearest.amount -= 5;
          this.carrying=true;
        }else if(nearest && dmin<80){
          this.pos.add(p5.Vector.sub(nearest.pos,this.pos).setMag(1));
        }else{
          const cx = constrain(Math.floor(this.pos.x/CELL_SIZE),0,GRID_SIZE-1);
          const cy = constrain(Math.floor(this.pos.y/CELL_SIZE),0,HEIGHT/CELL_SIZE-1);
          let bestDir = p5.Vector.random2D();
          let bestPher = soil[cx][cy].pheromone;
          for(let dx=-1; dx<=1; dx++){
            for(let dy=-1; dy<=1; dy++){
              if(dx===0 && dy===0) continue;
              let nx=cx+dx, ny=cy+dy;
              if(nx>=0 && nx<GRID_SIZE && ny>=0 && ny<HEIGHT/CELL_SIZE){
                let pher=soil[nx][ny].pheromone;
                if(pher>bestPher){
                  bestPher=pher;
                  bestDir=createVector(dx,dy);
                }
              }
            }
          }
          this.pos.add(bestDir.setMag(1));
        }
      }
      this.pos.add(p5.Vector.random2D().mult(0.3));
      this.pos.x = constrain(this.pos.x,0,width-1);
      this.pos.y = constrain(this.pos.y,0,height-1);
      const cx = constrain(Math.floor(this.pos.x/CELL_SIZE),0,GRID_SIZE-1);
      const cy = constrain(Math.floor(this.pos.y/CELL_SIZE),0,HEIGHT/CELL_SIZE-1);
      soil[cx][cy].pheromone += this.carrying ? 0.5 : 0.2;
    }
    display(){
      fill(this.carrying?'#e67e22':'#000');
      ellipse(this.pos.x,this.pos.y,5,5);
    }
    }

    function setup(){
    CELL_SIZE = Math.floor(Math.min(window.innerWidth, 800)/GRID_SIZE);
    WIDTH = CELL_SIZE * GRID_SIZE;
    HEIGHT = CELL_SIZE * GRID_HEIGHT;
    NEST_X = Math.floor(GRID_SIZE/2);
    NEST_Y = Math.floor(GRID_HEIGHT/2);
    PLANT_THRESHOLD = CELL_SIZE/2;
    let canvas = createCanvas(WIDTH, HEIGHT);
    canvas.id('canvas');
    for(let x=0;x<GRID_SIZE;x++){
      soil[x]=[];
      for(let y=0;y<HEIGHT/CELL_SIZE;y++){
        soil[x][y]=new SoilCell(x,y);
      }
    }
    soil[NEST_X][NEST_Y].isNest = true;
    initFood();
    initAnts(30);
    document.getElementById('antCount').addEventListener('input', e=>{
      const val = parseInt(e.target.value);
      document.getElementById('antCountLabel').textContent = val;
      initAnts(val);
    });
    }

    function draw(){
    background(250);
    if(frameCount>=nextNitrogenFrame){
      spawnNitrogenPatch();
      nextNitrogenFrame = frameCount + nitrogenInterval;
    }
    for(let x=0;x<GRID_SIZE;x++){
      for(let y=0;y<HEIGHT/CELL_SIZE;y++){
        soil[x][y].update();
        soil[x][y].display();
      }
    }
    for(let fs of foodSources){fs.display();}
    for(let ant of ants){ant.update(); ant.display();}

    if(mouseX>=0 && mouseX<width && mouseY>=0 && mouseY<height){
      const cx = Math.floor(mouseX/CELL_SIZE);
      const cy = Math.floor(mouseY/CELL_SIZE);
      const cell = soil[cx][cy];
      document.getElementById('stats').textContent =
        `위치 (${cx},${cy}) - 페로몬: ${cell.pheromone.toFixed(1)} `+
        `질소: ${cell.nitrogen.toFixed(1)} 식물: ${cell.plant.toFixed(1)}`;
    }
    }

    function initFood(){
    foodSources=[];
    for(let i=0;i<3;i++){
      foodSources.push(new FoodSource(random(width), random(height), 100));
    }
    }

function initAnts(n){
  ants=[];
  for(let i=0;i<n;i++) ants.push(new Ant());
}

function relocateNest(cell){
  cell.isNest = false;
  let best = null;
  let bestNitrogen = -1;
  for(let i=0;i<50;i++){
    const x = Math.floor(random(GRID_SIZE));
    const y = Math.floor(random(HEIGHT/CELL_SIZE));
    const c = soil[x][y];
    if(!c.isNest && c.plant < 1){
    if(c.nitrogen > bestNitrogen){
      bestNitrogen = c.nitrogen;
      best = c;
    }
    }
  }
  if(!best){
    best = soil[Math.floor(random(GRID_SIZE))][Math.floor(random(HEIGHT/CELL_SIZE))];
  }
  best.isNest = true;
}

    function getNearestNest(pos){
    let nearest=null;
    let dmin=9999;
    for(let x=0;x<GRID_SIZE;x++){
      for(let y=0;y<HEIGHT/CELL_SIZE;y++){
        if(soil[x][y].isNest){
          let c = createVector(x*CELL_SIZE+CELL_SIZE/2,y*CELL_SIZE+CELL_SIZE/2);
          let d=p5.Vector.dist(pos,c);
          if(d<dmin){dmin=d; nearest=soil[x][y];}
        }
      }
    }
    return nearest||soil[NEST_X][NEST_Y];
    }

    function spawnNitrogenPatch(){
  const cx = Math.floor(random(GRID_SIZE));
  const cy = Math.floor(random(HEIGHT/CELL_SIZE));
  foodSources.push(new FoodSource(cx*CELL_SIZE+CELL_SIZE/2, cy*CELL_SIZE+CELL_SIZE/2, nitrogenAmount));

    for(let dx=-1; dx<=1; dx++){
      for(let dy=-1; dy<=1; dy++){
        let nx=cx+dx, ny=cy+dy;
        if(nx>=0 && nx<GRID_SIZE && ny>=0 && ny<HEIGHT/CELL_SIZE){
          soil[nx][ny].nitrogen += nitrogenAmount/3;
        }
      }
    }
    }

    function mousePressed(){
    if(mouseX>=0 && mouseX<width && mouseY>=0 && mouseY<height){
      const cx = Math.floor(mouseX/CELL_SIZE);
      const cy = Math.floor(mouseY/CELL_SIZE);
      soil[cx][cy].isNest = !soil[cx][cy].isNest;
    }
    }

    document.getElementById('nitrogenAmount').addEventListener('input', e=>{
    nitrogenAmount = parseInt(e.target.value);
    document.getElementById('nitrogenAmountLabel').textContent = nitrogenAmount;
    });
    document.getElementById('nitrogenInterval').addEventListener('input', e=>{
    const val = parseInt(e.target.value);
    document.getElementById('nitrogenIntervalLabel').textContent = val;
    nitrogenInterval = val*60;
    });
  </script>
</body>
</html>
