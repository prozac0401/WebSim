<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ant–Nitrogen Cycle Simulator (Re‑built)</title>
<style>
  body{margin:0;padding:0;display:flex;justify-content:center;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#fafafa;}
  #ant-n-cycle{padding:10px;max-width:920px;width:100%;box-sizing:border-box;text-align:center;}
  canvas{display:block;margin:0 auto;background:#f8f9fa;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.15);width:100%;max-width:920px;}
  .controls{margin:10px auto;width:100%;text-align:center;}
  #legend{font-size:14px;margin:0 auto 10px auto;max-width:820px;width:100%;}
  #legend svg{width:12px;height:12px;vertical-align:middle;margin-left:10px;}
  #legend svg:first-child{margin-left:0;}
</style>
</head>
<body>
<div id="ant-n-cycle">
  <!-- p5.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>

  <!-- ⦿ UI Controls -->
  <div class="controls">
    <label>개미 수: <span id="antCountLabel">100</span></label>
    <input id="antCount" type="range" min="10" max="500" value="100" />
    <br/>
    <label>양분 패치 크기: <span id="nutrientAmountLabel">50</span></label>
    <input id="nutrientAmount" type="range" min="10" max="500" value="50" />
    <br/>
    <label>양분 생성주기(초): <span id="nutrientIntervalLabel">5</span></label>
    <input id="nutrientInterval" type="range" min="1" max="20" value="5" />
  </div>

  <!-- ⦿ Legend -->
  <div id="legend">
    <style>#legend rect,#legend circle,#legend line{pointer-events:none;}</style>
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#b5651d"/></svg>둥지
    <svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="2" fill="#000"/><circle cx="6" cy="6" r="2.5" fill="#000"/><circle cx="6" cy="9" r="3" fill="#000"/></svg>개미
    <svg viewBox="0 0 12 12"><circle cx="6" cy="6" r="4" fill="#ffb6c1"/></svg>사탕 부스러기(양분)
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#228B22" opacity="0.6"/></svg>질소 음영
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#8B4513" opacity="0.6"/></svg>유기물 음영
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#FF69B4" opacity="0.6"/></svg>개화 가능 지역
  </div>

  <!-- ⦿ Buttons -->
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="resetBtn">Reset</button>
  </div>

<script>
/* =============================== CONSTANTS =============================== */
const GRID_SIZE     = 30;
const MAX_NESTS     = 6;
const TREE_LIFESPAN = 800; // frames
const STILL_LIMIT   = 600; // ant inactive kill threshold
// Flower bloom condition thresholds
const N_THRESHOLD   = 3;   // nitrogen
const O_THRESHOLD   = 2;   // organic
const AGE_THRESHOLD = 120; // frames matured
const BLOOM_CHANCE  = 0.3; // probability per frame after matured
/* =============================== Globals =============================== */
let CELL_SIZE, WIDTH, HEIGHT;
let NEST_X, NEST_Y;
let nutrientAmount   = 50;
let nutrientInterval = 5 * 60; // frames   (UI seconds * 60 FPS)
let nextNutrientFrame;
let nestCount;
let soil = [];
let ants = [];
let foodSources = [];
let ANT_SIZE, ANT_SPEED;
/* =============================== Utilities =============================== */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;};}
/* =============================== Classes =============================== */
class SoilCell{
  constructor(x,y){
    this.x=x;this.y=y;
    this.organic=0;this.nitrogen=0;
    this.plant=0;      // tree height proxy (<=1 : no tree)
    this.pheromone=0;
    this.isNest=false;
    this.plantAge=0;   // frames since tree sprouted
    this.treeSpawned=false; // prevents double spawn
    this.bloomCounter=0;    // frames meeting conditions
    this.bloomPotential=0;  // 0..1 for shading
  }
  update(){
    /* ⇄ nutrient cycling */
    const dn = this.organic*0.02; this.nitrogen += dn; this.organic -= dn;
    const uptake = this.nitrogen*0.01; this.plant += uptake*5; this.nitrogen -= uptake;
    const decay  = this.plant*0.005;   this.plant -= decay;    this.nitrogen += decay;

    /* flower‑bloom potential & spawning */
    if(!this.isNest && this.plant<=1){
      // compute normalized potentials and average
      const nPot = this.nitrogen/N_THRESHOLD;
      const oPot = this.organic/O_THRESHOLD;
      this.bloomPotential = constrain((nPot+oPot)/2,0,1);
      if(this.bloomPotential>=1){ this.bloomCounter++; }
      else                      { this.bloomCounter=0; }
      if(this.bloomCounter>AGE_THRESHOLD && random()<BLOOM_CHANCE && !this.treeSpawned){
        this.plant = 2; // initial tree height
        this.treeSpawned = true;
      }
    } else {
      this.bloomPotential = 0; this.bloomCounter = 0;
    }

    /* tree ageing */
    if(this.plant>1){
      this.plantAge++;
      if(this.plantAge > TREE_LIFESPAN){ this.nitrogen += this.plant; this.plant=0; this.plantAge=0; }
    } else { this.plantAge=0; }

    /* pheromone evaporation */
    this.pheromone *= 0.95;
  }
  displayGround(){
    const x=this.x*CELL_SIZE, y=this.y*CELL_SIZE;
    noStroke(); fill('#FFFFF0'); rect(x,y,CELL_SIZE,CELL_SIZE);
    if(this.nitrogen>0.05){ fill(34,139,34,constrain(this.nitrogen*60,0,160)); rect(x,y,CELL_SIZE,CELL_SIZE);} // green
    if(this.organic>0.05){ fill(139,69,19,constrain(this.organic*60,0,160)); rect(x,y,CELL_SIZE,CELL_SIZE);} // brown
    if(this.bloomPotential>0 && this.plant<=1){ fill(255,105,180,constrain(this.bloomPotential*120,0,120)); rect(x,y,CELL_SIZE,CELL_SIZE);} // pink
    if(this.pheromone>0.1){ fill(180,80,200,constrain(this.pheromone*50,0,150)); rect(x,y,CELL_SIZE,CELL_SIZE); }
    if(this.nitrogen>0.5 && !this.isNest && this.plant<=1){ fill('#ffb6c1'); ellipse(x+CELL_SIZE/2,y+CELL_SIZE/2,CELL_SIZE*0.3); }
    if(this.isNest){ fill('#b5651d'); rect(x,y,CELL_SIZE,CELL_SIZE); }
  }
  displayPlant(){ if(this.plant>1){ drawCherryTree(this.x,this.y,this.plant);} }
}

class FoodSource{
  constructor(x,y,amount){
    this.pos=createVector(x,y); this.amount=this.initial=amount; this.shape=[];
    for(let i=0;i<8;i++){const ang=TWO_PI*i/8+random(-0.2,0.2);const rad=CELL_SIZE*0.8*random(0.8,1.2);this.shape.push({x:cos(ang)*rad,y:sin(ang)*rad});}
  }
  display(){ if(this.amount<=0) return; const frac=this.amount/this.initial; const step=Math.ceil(frac*5)/5; const col=color('#ffb6c1'); col.setAlpha(200*step+55);
    fill(col); stroke(255,255,255,180*step); strokeWeight(1); push(); translate(this.pos.x,this.pos.y); beginShape(); this.shape.forEach(v=>vertex(v.x*step,v.y*step)); endShape(CLOSE); pop(); }
}

class Ant{
  constructor(){ this.pos=createVector(random(width),random(height)); this.prevPos=this.pos.copy(); this.vel=createVector(1,0); this.carrying=false; this.load=0; this.isResting=false; this.dir=int(random(4)); this.still=0; }
  update(){
    const prev=this.pos.copy();
    const cx=floor(this.pos.x/CELL_SIZE); const cy=floor(this.pos.y/CELL_SIZE); const cell=soil[cx][cy];

    if(this.isResting){ if(cell.pheromone>0.1) this.isResting=false; else return; }
    if(cell.plant>1){ this.pos=prev; this.dir=(this.dir+2)%4; }
    else if(this.carrying){ // return to nest carrying organic load
      const nestCell=getNearestNest(this.pos); const target=createVector(nestCell.x*CELL_SIZE+CELL_SIZE/2,nestCell.y*CELL_SIZE+CELL_SIZE/2);
      this.pos.add(p5.Vector.sub(target,this.pos).setMag(ANT_SPEED));
      if(dist(this.pos.x,this.pos.y,target.x,target.y)<5){ nestCell.organic+=this.load; this.carrying=false; }
    } else {
      let nearest=null, dmin=1e9;
      foodSources.forEach(fs=>{ if(fs.amount>0){ const d=dist(this.pos.x,this.pos.y,fs.pos.x,fs.pos.y); if(d<dmin){ dmin=d; nearest=fs; }}});
      if(nearest && dmin<5){ const take=min(5,nearest.amount); nearest.amount-=take; this.carrying=true; this.load=take; }
      else if(nearest && dmin<80){ this.pos.add(p5.Vector.sub(nearest.pos,this.pos).setMag(ANT_SPEED)); }
      else {
        if(random()<0.02) this.dir=int(random(4));
        if(this.dir===0) this.pos.y-=ANT_SPEED; else if(this.dir===1) this.pos.x+=ANT_SPEED; else if(this.dir===2) this.pos.y+=ANT_SPEED; else this.pos.x-=ANT_SPEED;
      }
    }
    /* keep in bounds */
    this.pos.x=constrain(this.pos.x,0,width-1); this.pos.y=constrain(this.pos.y,0,height-1);
    /* pheromone */
    soil[floor(this.pos.x/CELL_SIZE)][floor(this.pos.y/CELL_SIZE)].pheromone += this.carrying?0.5:0.2;
    /* motion stats */
    this.vel=p5.Vector.sub(this
