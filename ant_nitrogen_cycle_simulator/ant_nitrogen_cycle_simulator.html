<!-- Ant–Nitrogen Cycle Simulator (Flower‑Logic v2)
     ★ 주요 추가 · 변경 ★
     1. 현실적인 꽃 개화 조건
        – N_THRESHOLD, O_THRESHOLD, AGE_THRESHOLD, BLOOM_CHANCE 상수 도입
        – nitrogen·organic·성숙기간·확률 충족 시 ‘벚꽃나무’ 개화
     2. 잠재 개화 영역 시각화(연한 분홍 음영)
        – 매 프레임 bloomPotential 계산 → 음영 강도 알파값으로 표시(다른 음영 위 우선)
     3. 레전드에 ‘개화 가능 지역’ 추가
     4. 코드 정리·주석 보강
-->
<div id="ant-n-cycle">
  <style>
    #ant-n-cycle {margin:0 auto;padding:10px;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;max-width:920px;text-align:center;box-sizing:border-box;}
    #ant-n-cycle canvas {display:block;margin:0 auto;background:#f8f9fa;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.2);width:100%;max-width:920px;}
    #ant-n-cycle .controls {width:100%;margin:10px auto;text-align:center;}
  </style>
  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <!-- UI -->
  <div class="controls">
    <label>개미 수: <span id="antCountLabel">100</span></label>
    <input id="antCount" type="range" min="10" max="500" value="100" />
    <br/>
    <label>양분 패치 크기: <span id="nutrientAmountLabel">50</span></label>
    <input id="nutrientAmount" type="range" min="10" max="500" value="50" />
    <br/>
    <label>양분 생성주기(초): <span id="nutrientIntervalLabel">5</span></label>
    <input id="nutrientInterval" type="range" min="1" max="20" value="5" />
  </div>
  <!-- Legend -->
  <div id="legend" style="max-width:820px;margin:0 auto 10px auto;font-size:14px;width:100%;">
    <style>#legend svg{width:12px;height:12px;margin-left:10px;vertical-align:middle;}#legend svg:first-child{margin-left:0;}</style>
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#b5651d"/></svg>둥지
    <svg viewBox="0 0 12 12"><circle cx="6" cy="3" r="2" fill="#000"/><circle cx="6" cy="6" r="2.5" fill="#000"/><circle cx="6" cy="9" r="3" fill="#000"/></svg>개미
    <svg viewBox="0 0 12 12"><circle cx="6" cy="6" r="4" fill="#ffb6c1"/></svg>사탕 부스러기(양분)
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#228B22" opacity="0.6"/></svg>질소 농도(녹색 음영)
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#8B4513" opacity="0.6"/></svg>유기물 농도(갈색 음영)
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#FF69B4" opacity="0.6"/></svg>개화 가능 지역(분홍 음영)
  </div>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="resetBtn">Reset</button>
  </div>

  <script>
    /* ───────────────────────── CONSTS ───────────────────────── */
    const GRID_SIZE = 30;
    const MAX_NESTS = 6;
    const TREE_LIFESPAN = 800;
    const STILL_LIMIT   = 600;

    /* 꽃 개화 조건 상수 */
    const N_THRESHOLD   = 3;      // 최소 질소 농도
    const O_THRESHOLD   = 2;      // 최소 유기물 농도
    const AGE_THRESHOLD = 120;    // 성숙 프레임
    const BLOOM_CHANCE  = 0.30;   // 확률 요소

    /* 시뮬 전역 변수 */
    let CELL_SIZE, WIDTH, HEIGHT;
    let NEST_X, NEST_Y;
    let nutrientAmount = 50;
    let nutrientInterval = 5*60;
    let nextNutrientFrame;
    let nestCount;

    /* 컬렉션 */
    let soil = [];
    let ants = [];
    let foodSources = [];

    /* 시뮬 조정 */
    let ANT_SIZE, ANT_SPEED;

    /* ───────────────────────── UTIL ───────────────────────── */
    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};}

    /* ───────────────────────── SoilCell ───────────────────────── */
    class SoilCell{
      constructor(x,y){Object.assign(this,{x,y,organic:0,nitrogen:0,plant:0,pheromone:0,isNest:false,plantAge:0,treeSpawned:false,bloomCounter:0,bloomPotential:0});}
      update(){
        /* 유기물→질소 →식물 성장 →분해 */
        this.nitrogen += this.organic*0.02;   this.organic  *= 0.98;
        const uptake = this.nitrogen*0.01;    this.plant    += uptake*5;   this.nitrogen -= uptake;
        const decay  = this.plant*0.005;      this.plant    -= decay;      this.nitrogen += decay;

        /* 꽃 개화 잠재력 계산 */
        if(!this.isNest && this.plant<=1){
          this.bloomPotential = constrain(((this.nitrogen/N_THRESHOLD)+(this.organic/O_THRESHOLD))/2,0,1);
          if(this.bloomPotential>=1){ this.bloomCounter++; }
          else                       { this.bloomCounter = 0; }
          /* 실제 개화 */
          if(this.bloomCounter>AGE_THRESHOLD && random()<BLOOM_CHANCE && !this.treeSpawned){
            this.plant = 2;          // 바로 작은 나무로 성장
            this.treeSpawned = true; // 중복 방지
          }
        } else {
          this.bloomPotential = 0;   this.bloomCounter = 0;
        }

        /* 식물 노화 후 나무 제거 */
        if(this.plant>1){
          this.plantAge++;
          if(this.plantAge>TREE_LIFESPAN){ this.nitrogen += this.plant; this.plant=0; this.plantAge=0; }
        } else { this.plantAge=0; }

        /* 페로몬 감쇠 */
        this.pheromone *= 0.95;
      }
      displayGround(){
        /* 기본 배경 */
        noStroke(); fill('#FFFFF0');
        rect(this.x*CELL_SIZE,this.y*CELL_SIZE,CELL_SIZE,CELL_SIZE);

        /* 질소 음영 (녹색) */
        if(this.nitrogen>0.05){ fill(34,139,34,constrain(this.nitrogen*60,0,160)); rect(this.x*CELL_SIZE,this.y*CELL_SIZE,CELL_SIZE,CELL_SIZE); }
        /* 유기물 음영 (갈색) */
        if(this.organic>0.05){ fill(139,69,19,constrain(this.organic*60,0,160)); rect(this.x*CELL_SIZE,this.y*CELL_SIZE,CELL_SIZE,CELL_SIZE); }
        /* 꽃 잠재력 음영 (분홍, 가장 마지막에 그려 dominance 확보) */
        if(this.bloomPotential>0 && this.plant<=1){ fill(255,105,180,constrain(this.bloomPotential*120,0,120)); rect(this.x*CELL_SIZE,this.y*CELL_SIZE,CELL_SIZE,CELL_SIZE); }

        /* 페로몬 */
        if(this.pheromone>0.1){ fill(180,80,200,constrain(this.pheromone*50,0,150)); rect(this.x*CELL_SIZE,this.y*CELL_SIZE,CELL_SIZE,CELL_SIZE); }

        /* 사탕 부스러기 표시 */
        if(this.nitrogen>0.5 && !this.isNest && this.plant<=1){ fill('#ffb6c1'); ellipse(this.x*CELL_SIZE+CELL_SIZE/2,this.y*CELL_SIZE+CELL_SIZE/2,CELL_SIZE*0.3); }
        /* 둥지 */
        if(this.isNest){ fill('#b5651d'); rect(this.x*CELL_SIZE,this.y*CELL_SIZE,CELL_SIZE,CELL_SIZE);}  }
      displayPlant(){ if(this.plant>1){ drawCherryTree(this.x,this.y,this.plant);} }
    }

    /* ───────────────────────── FoodSource ───────────────────────── */
    class FoodSource{ constructor(x,y,amount){this.pos=createVector(x,y);this.amount=this.initial=amount;this.shape=[];for(let i=0;i<8;i++){const ang=TWO_PI*i/8+random(-0.2,0.2);const rad=CELL_SIZE*0.8*random(0.8,1.2);this.shape.push({x:cos(ang)*rad,y:sin(ang)*rad});}} display(){if(this.amount<=0) return; const f=this.amount/this.initial;const s=Math.ceil(f*5)/5; const c=color('#ffb6c1'); c.setAlpha(200*s+55); fill(c); stroke(255,255,255,180*s); strokeWeight(1); push();translate(this.pos.x,this.pos.y); beginShape(); this.shape.forEach(v=>vertex(v.x*s,v.y*s)); endShape(CLOSE); pop();}}

    /* ───────────────────────── Ant ───────────────────────── */
    class Ant{constructor(){this.pos=createVector(random(width),random(height));this.prevPos=this.pos.copy();this.vel=createVector(1,0);this.carrying=false;this.carryingAmount=0;this.isResting=false;this.dir=int(random(4));this.still=0;} update(){const prev=this.pos.copy();const cx=floor(this.pos.x/CELL_SIZE);const cy=floor(this.pos.y/CELL_SIZE);const cell=soil[cx][cy]; if(this.isResting){if(cell.pheromone>0.1)this.isResting=false;else return;} if(cell.plant>1){this.pos=prev;this.dir=(this.dir+2)%4;} else if(this.carrying){const nest=getNearestNest(this.pos);const tgt=createVector(nest.x*CELL_SIZE+CELL_SIZE/2,nest.y*CELL_SIZE+CELL_SIZE/2);this.pos.add(p5.Vector.sub(tgt,this.pos).setMag(ANT_SPEED));if(dist(this.pos.x,this.pos.y,tgt.x,tgt.y)<5){nest.organic+=this.carryingAmount;this.carrying=false;}} else {let nearest=null,dmin=1e9;foodSources.forEach(fs=>{if(fs.amount>0){const d=dist(this.pos.x,this.pos.y,fs.pos.x,fs.pos.y);if(d<dmin){dmin=d;nearest=fs;}}}); if(nearest&&dmin<5){const take=min(5,nearest.amount);nearest.amount-=take;this.carrying=true;this.carryingAmount=take;} else if(nearest&&dmin<80){this.pos.add(p5.Vector.sub(nearest.pos,this.pos).setMag(ANT_SPEED));} else {if(random()<0.02) this.dir=int(random(4)); if(this.dir===0) this.pos.y-=ANT_SPEED; if(this.dir===1) this.pos.x+=ANT_SPEED; if(this.dir===2) this.pos.y+=ANT_SPEED; if(this.dir===3) this.pos.x-=ANT_SPEED; }} this.pos.x=constrain(this.pos.x,0,width-1);this.pos.y=constrain(this.pos.y,0,height-1);const nx=floor(this.pos.x/CELL_SIZE);const ny=floor(this.pos.y/CELL_SIZE);soil[nx][ny].pheromone+=this.carrying?0.5:0.2; this.vel=p5.Vector.sub(this.pos,prev); (this.vel.mag()<0.5)?this.still++:this.still=0; if(this.still>STILL_LIMIT)this.dead=true;} display(){const bodyCol=this.carrying?'#d020d0':'#000'; push();translate(this.pos.x,this.pos.y);rotate(this.vel.heading()+HALF_PI); noStroke();fill(bodyCol);ellipse(0,-ANT_SIZE*0.3,ANT_SIZE*0.4);ellipse(0,0,ANT_SIZE*0.5);ellipse(0,ANT
