<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ant–Nitrogen Cycle Simulator (v7 — 완성)</title>
<style>
  body{margin:0;padding:0;display:flex;justify-content:center;background:#fafafa;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
  #ant-n-cycle{padding:10px;max-width:960px;width:100%;box-sizing:border-box;text-align:center;}
  canvas{display:block;margin:0 auto;background:#f8f9fa;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.15);width:100%;max-width:960px;}
  .controls{margin:10px auto;text-align:center;width:100%;}
  #legend{font-size:14px;margin:0 auto 10px auto;max-width:860px;width:100%;}
  #legend svg{width:12px;height:12px;vertical-align:middle;margin-left:10px;}
  #legend svg:first-child{margin-left:0;}
</style>
</head>
<body>
<div id="ant-n-cycle">
  <!-- p5.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>

  <!-- ⦿ UI Controls -->
  <div class="controls">
    <label>개미 수: <span id="antCountLabel">100</span></label>
    <input id="antCount" type="range" min="10" max="500" value="100" />
    <br/>
    <label>양분 패치 크기: <span id="nutrientAmountLabel">50</span></label>
    <input id="nutrientAmount" type="range" min="10" max="500" value="50" />
    <br/>
    <label>양분 생성주기(초): <span id="nutrientIntervalLabel">5</span></label>
    <input id="nutrientInterval" type="range" min="1" max="20" value="5" />
  </div>

  <!-- ⦿ Legend -->
  <div id="legend">
    <style>#legend rect,#legend circle,#legend line{pointer-events:none;}</style>
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#b5651d"/></svg>둥지
    <svg viewBox="0 0 12 12"><circle cx="6" cy="6" r="4" fill="#ffb6c1"/></svg>사탕 부스러기
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#228B22" opacity="0.5"/></svg>질소 음영
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#8B4513" opacity="0.5"/></svg>유기물 음영
    <svg viewBox="0 0 12 12"><rect width="12" height="12" fill="#FF69B4" opacity="0.5"/></svg>개화 가능 지역
    <svg viewBox="0 0 12 12"><path d="M0 0 L12 0 M0 0 L0 12" stroke="#cccccc"/></svg>격자
  </div>

  <!-- ⦿ Buttons -->
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="resetBtn">Reset</button>
  </div>

<script>
(()=>{
/****************************** CONSTANTS ******************************/
const GRID_SIZE=30,TREE_LIFESPAN=800,STILL_LIMIT=600,MAX_NESTS=6;const N_TH=3,O_TH=2,AGE_TH=120,BLOOM_P=0.3;
/**************************** Runtime vars *****************************/
let CELL,WIDTH,HEIGHT,NX,NY;let nutrientAmt=50,nutrientInt=5*60,nextNutrient=0;let soil=[],ants=[],foods=[];let ANT_S,ANT_V;let running=true;
/***************************** p5 sketch ******************************/
const sketch=p=>{
 p.setup=()=>{
   CELL=Math.floor(Math.min(p.windowWidth*0.9,920)/GRID_SIZE);
   WIDTH=CELL*GRID_SIZE;HEIGHT=WIDTH;NX=Math.floor(GRID_SIZE/2);NY=NX;
   ANT_S=CELL*0.4;ANT_V=CELL*0.1;
   const cnv=p.createCanvas(WIDTH,HEIGHT);cnv.parent('ant-n-cycle');
   initSoil();initAnts(100);initFoods();
   // UI binds
   p.select('#antCount').input(e=>{p.select('#antCountLabel').html(e.target.value);initAnts(+e.target.value);});
   p.select('#nutrientAmount').input(e=>{nutrientAmt=+e.target.value;p.select('#nutrientAmountLabel').html(nutrientAmt);});
   p.select('#nutrientInterval').input(e=>{nutrientInt=+e.target.value*60;p.select('#nutrientIntervalLabel').html(+e.target.value);});
   p.select('#startBtn').mousePressed(()=>{running=true;});p.select('#stopBtn').mousePressed(()=>{running=false;});
   p.select('#resetBtn').mousePressed(()=>{initSoil();initAnts(+p.select('#antCount').value());initFoods();running=true;});
 };
 p.draw=()=>{if(!running) return; if(p.frameCount>=nextNutrient){spawnPatch();nextNutrient=p.frameCount+nutrientInt;}
   // update
   soil.flat().forEach(c=>c.update()); ants.forEach(a=>a.update()); foods=foods.filter(f=>f.amount>0);
   // render
   p.background(250);
   soil.flat().forEach(c=>{c.displayGround();});
   drawGrid();
   foods.forEach(f=>f.display(p));
   ants.forEach(a=>a.display(p));
   soil.flat().forEach(c=>c.displayPlant());
 };
 /* Helpers inside p5 context */
 function drawGrid(){p.stroke(204,204,204,80);p.strokeWeight(1);for(let i=0;i<=GRID_SIZE;i++){p.line(i*CELL,0,i*CELL,HEIGHT);p.line(0,i*CELL,WIDTH,i*CELL);}}
 function rng(a){return()=>{var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};}
 /* Classes */
 class Soil{constructor(x,y){this.x=x;this.y=y;this.o=0;this.n=0;this.p=0;this.ph=0;this.nest=false;this.age=0;this.bloom=0;this.tree=false;}
  update(){const dn=this.o*0.02;this.n+=dn;this.o-=dn;const up=this.n*0.01;this.p+=up*5;this.n-=up;const dc=this.p*0.005;this.p-=dc;this.n+=dc;
   // bloom potential
   if(!this.nest&&this.p<=1){this.bloom=((this.n/N_TH)+(this.o/O_TH))/2; if(this.bloom>=1){this.age++;}else this.age=0; if(this.age>AGE_TH&&Math.random()<BLOOM_P&&!this.tree){this.p=2;this.tree=true;}}
   else {this.bloom=0;this.age=0;}
   if(this.p>1){this.age++;if(this.age>TREE_LIFESPAN){this.n+=this.p;this.p=0;this.age=0;this.tree=false;}}
   this.ph*=0.95; }
  displayGround(){const x=this.x*CELL,y=this.y*CELL;p.noStroke();p.fill('#FFFFF0');p.rect(x,y,CELL,CELL);
   if(this.n>0.05){p.fill(34,139,34,Math.min(this.n*60,160));p.rect(x,y,CELL,CELL);} if(this.o>0.05){p.fill(139,69,19,Math.min(this.o*60,160));p.rect(x,y,CELL,CELL);}
   if(this.bloom>0&&this.p<=1){p.fill(255,105,180,Math.min(this.bloom*120,120));p.rect(x,y,CELL,CELL);} if(this.nest){p.fill('#b5651d');p.rect(x,y,CELL,CELL);} }
  displayPlant(){if(this.p>1) drawTree(this.x,this.y,this.p);} }
 class Food{constructor(x,y,amt){this.pos=p.createVector(x,y);this.init=amt;this.amount=amt;this.shape=[];for(let i=0;i<8;i++){const ang=TWO_PI*i/8+p.random(-0.2,0.2);const rad=CELL*0.8*p.random(0.8,1.2);this.shape.push({x:Math.cos(ang)*rad,y:Math.sin(ang)*rad});}}
  display(){const frac=this.amount/this.init;if(frac<=0) return;const step=Math.ceil(frac*5)/5;const col=p.color('#ffb6c1');col.setAlpha(200*step+55);p.fill(col);p.noStroke();p.push();p.translate(this.pos.x,this.pos.y);p.beginShape();this.shape.forEach(v=>p.vertex(v.x*step,v.y*step));p.endShape(p.CLOSE);p.pop();}}
 class Ant{constructor(){this.pos=p.createVector(p.random(WIDTH),p.random(HEIGHT));this.vel=p.createVector(1,0);this.carry=false;this.load=0;this.dir=p.int(p.random(4));this.still=0;}
  update(){const px=this.pos.copy();const cx=Math.floor(this.pos.x/CELL),cy=Math.floor(this.pos.y/CELL);const cell=soil[cx][cy];if(cell.p>1){this.dir=(this.dir+2)%4;}
   if(this.carry){const nest=nearestNest(this.pos);const tgt=p.createVector(nest.x*CELL+CELL/2,nest.y*CELL+CELL/2);this.pos.add(p5.Vector.sub(tgt,this.pos).setMag(ANT_V));if(p.dist(this.pos.x,this.pos.y,tgt.x,tgt.y)<2){nest.o+=this.load;this.carry=false;this.load=0;}}
   else{let near=null,dmin=1e9;foods.forEach(f=>{if(f.amount>0){const d=p.dist(this.pos.x,this.pos.y,f.pos.x,f.pos.y);if(d<dmin){dmin=d;near=f;}}});
     if(near&&dmin<5){const take=Math.min(5,near.amount);near.amount-=take;this.carry=true;this.load=take;}
     else if(near&&dmin<80){this.pos.add(p5.Vector.sub(near.pos,this.pos).setMag(ANT_V));}
     else {if(Math.random()<0.02) this.dir=p.int(p.random(4)); if(this.dir===0) this.pos.y-=ANT_V;else if(this.dir===1) this.pos.x+=ANT_V;else if(this.dir===2) this.pos.y+=ANT_V;else this.pos.x-=ANT_V;}}
   this.pos.x=p.constrain(this.pos.x,0,WIDTH-1);this.pos.y=p.constrain(this.pos.y,0,HEIGHT-1);soil[Math.floor(this.pos.x/CELL)][Math.floor(this.pos.y/CELL)].ph+=this.carry?0.5:0.2;
   this.vel=p5.Vector.sub(this.pos,px);if(this.vel.magSq()<0.5)this.still++;else this.still=0;if(this.still>STILL_LIMIT){const n=nearestNest(this.pos);this.pos.set(n.x*CELL+CELL/2,n.y*CELL+CELL/2);this.still=0;}}
  display(){p.noStroke();p.fill(this.carry?'#d020d0':'#000');p.push();p.translate(this.pos.x,this.pos.y);p.rotate(this.vel.heading()+p.HALF_PI);
   p.ellipse(0,-ANT_S*0.3,ANT_S*0.4);p.ellipse(0,0,ANT_S*0.5);p.ellipse(0,ANT_S*0.35,ANT_S*0.6);
   if(this.carry){p.fill('#ffb6c1');p.ellipse(0,-ANT_S*0.8,ANT_S*0.3);}p.pop();}}
 function drawTree(x,y,h){p.push();p.translate(x*CELL+CELL/2,y*CELL);p.stroke(139,69,19);p.strokeWeight(6);p.line(0,CELL,0,CELL-h);p.noStroke();const rand=rng(x*1000+y);for(let i=0;i<20;i++){const ang=rand()*TWO_PI,rad=rand()*(h*0.6)+h*0.2;sx=Math.cos(ang)*rad;sy=-rad*0.6;size=rand()*(h*0.15)+h*0.15;p.fill(p.random(['#ffc6dc','#ffd9e8','#ffeef5']));p.ellipse(sx,sy,size);}p.pop();}
 /* util funcs */
 function nearestNest(pos){let best=soil[NX][NY],dmin=1e9;soil.flat().forEach(c=>{if(c.nest){const d=p.dist(pos.x,pos.y,c.x*CELL+CELL/2,c.y*CELL+CELL/2);if(d<dmin){dmin=d;best=c;}}});return best;}
 function initSoil(){soil=[];for(let x=0;x<GRID_SIZE;x++){soil[x]=[];for(let y=0;y<GRID_SIZE;y++){soil[x][y]=new Soil(x,y);}}soil[NX][NY].nest=true;}
 function initAnts(n){ants=[];for(let i=0;i<n;i++)ants.push(new Ant());}
 function initFoods(){foods=[];for(let i=0;i<3;i++){foods.push(new Food(p.random(WIDTH),p.random(HEIGHT),nutrientAmt));}}
 function spawnPatch(){let cx,cy;do{cx=p.int(p.random(GRID_SIZE));cy=p.int(p.random(GRID_SIZE));}while(soil[cx][cy].p>1);foods.push(new Food(cx*CELL+CELL/2,cy*CELL+CELL/2,nutrientAmt));soil[cx][cy].o+=nutrientAmt;}
};
new p5(sketch);
})();
</script>
</div>
</body>
</html>
